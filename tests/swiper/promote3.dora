//= vm-args "--gc=swiper --gc-verify"

fun main() {
  var x = foo(1I, foo(2I, foo(3I, None[Foo])));
  std::forceMinorCollect();
  x.getOrPanic().next.getOrPanic().next.getOrPanic().next = foo(4I, None[Foo]);
  x = foo(100I, x);
  std::forceMinorCollect();
  assert(x.getOrPanic().a == 100I);
  assert(x.getOrPanic().next.getOrPanic().a == 1I);
  assert(x.getOrPanic().next.getOrPanic().next.getOrPanic().a == 2I);
  assert(x.getOrPanic().next.getOrPanic().next.getOrPanic().next.getOrPanic().a == 3I);
  assert(x.getOrPanic().next.getOrPanic().next.getOrPanic().next.getOrPanic().next.getOrPanic().a == 4I);
  assert(x.getOrPanic().next.getOrPanic().next.getOrPanic().next.getOrPanic().next.getOrPanic().next.isNone());
}

class Foo(let a: Int32, var next: Option[Foo])

fun foo(a: Int32, next: Option[Foo]): Option[Foo] {
  Some[Foo](Foo(a, next))
}
