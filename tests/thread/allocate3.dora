//= vm-args "--gc-young-size=64M --max-heap-size=128M --gc-verify"

class MyThread() extends std::Thread {
    @override fun run() {
        allocator();
        println("done");
    }
}

fun main() {
    var i = 0I;

    while i < 4I {
        let thread = MyThread();
        thread.start();
        i = i + 1I;
    }

    allocator();
    println("done");
}

fun allocator() {
    var i = 0I;

    while i < 10_000I {
        let foo = {
            let v1 = Foo(i, None[Foo]);
            let v2 = Foo(i + 1I, Some[Foo](v1));
            let v3 = Foo(i + 2I, Some[Foo](v2));
            let v4 = Foo(i + 3I, Some[Foo](v3));
            Foo(i + 4I, Some[Foo](v4))
        };

        if i % 500I == 0I { std::forceMinorCollect(); }

        var tmp = foo;
        assert(tmp.value == i + 4I);
        tmp = tmp.next.getOrPanic();
        assert(tmp.value == i + 3I);
        tmp = tmp.next.getOrPanic();
        assert(tmp.value == i + 2I);
        tmp = tmp.next.getOrPanic();
        assert(tmp.value == i + 1I);
        tmp = tmp.next.getOrPanic();
        assert(tmp.value == i);

        i = i + 1I;
    }
}

class Foo(let value: Int32, let next: Option[Foo])