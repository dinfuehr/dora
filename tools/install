#!/usr/bin/env bash

set -euo pipefail

if [[ $# -ne 1 ]]; then
    echo "Usage: $0 <release-tarball>" >&2
    exit 1
fi

ARCHIVE=$1

if [[ ! -f "$ARCHIVE" ]]; then
    echo "Archive not found: $ARCHIVE" >&2
    exit 1
fi

TMPDIR=$(mktemp -d -t dora-install-XXXXXX)
trap 'rm -rf "$TMPDIR"' EXIT

tar -xzf "$ARCHIVE" -C "$TMPDIR"

STAGING="$TMPDIR/dora"
if [[ ! -d "$STAGING" ]]; then
    STAGING=$(find "$TMPDIR" -mindepth 1 -maxdepth 1 -type d | head -n 1)
fi

if [[ -z "${STAGING:-}" || ! -d "$STAGING" ]]; then
    echo "Could not find extracted directory in $TMPDIR" >&2
    exit 1
fi

BIN_SRC="$STAGING/bin"
SHARE_SRC="$STAGING/share"

if [[ ! -d "$BIN_SRC" || ! -d "$SHARE_SRC" ]]; then
    echo "Archive is missing bin/ or share directories." >&2
    exit 1
fi

BIN_DEST="$HOME/.local/bin"
SHARE_DEST="$HOME/.local/share/dora"

mkdir -p "$BIN_DEST"
cp "$BIN_SRC"/* "$BIN_DEST"/
echo "Installed binaries into $BIN_DEST"

rm -rf "$SHARE_DEST"
mkdir -p "$SHARE_DEST"
cp -R "$SHARE_SRC"/* "$SHARE_DEST"/
echo "Installed share contents into $SHARE_DEST"
