#!/usr/bin/env -S uv run --script

# /// script
# requires-python = ">=3.12"
# dependencies = []
# ///

import argparse
import shlex
import subprocess
import sys
from pathlib import Path

REPO_ROOT = Path(__file__).resolve().parent.parent


def run(cmd: list[str]) -> None:
    print("+", " ".join(shlex.quote(part) for part in cmd))
    subprocess.run(cmd, check=True, cwd=REPO_ROOT)


def parse_args(argv: list[str]) -> tuple[bool, list[str]]:
    parser = argparse.ArgumentParser(
        description="Run Dora's full test suite (debug or release)."
    )
    parser.add_argument(
        "-r",
        "--release",
        action="store_true",
        help="Run all stages in release mode.",
    )
    parser.add_argument(
        "pytester_args",
        nargs=argparse.REMAINDER,
        help="Arguments forwarded to pytester (pass after `--`).",
    )
    args = parser.parse_args(argv)

    pytester_args = list(args.pytester_args)
    if pytester_args and pytester_args[0] == "--":
        pytester_args = pytester_args[1:]

    return args.release, pytester_args


def gather_pkg_files(pkg_name: str) -> list[Path]:
    pkgs_root = REPO_ROOT / "pkgs"
    candidates: list[Path] = []

    direct = pkgs_root / pkg_name
    if direct.is_dir():
        candidates.append(direct)
    else:
        for path in pkgs_root.rglob(pkg_name):
            if path.is_dir():
                candidates.append(path)

    if not candidates:
        return []

    files: list[Path] = []
    for base in sorted({path.resolve() for path in candidates}):
        files.extend(sorted(base.rglob("*.dora")))
    return files


def run_formatter(files: list[Path]) -> None:
    for path in files:
        rel_path = str(path.relative_to(REPO_ROOT))
        cmd = ["cargo", "run", "-p", "dora-format", "--", rel_path]
        print(rel_path)
        try:
            subprocess.run(
                cmd,
                check=True,
                cwd=REPO_ROOT,
                stdout=subprocess.DEVNULL,
                stderr=subprocess.DEVNULL,
            )
        except subprocess.CalledProcessError:
            print("+", " ".join(shlex.quote(part) for part in cmd))
            raise


def main(argv: list[str]) -> int:
    release_mode, pytester_args = parse_args(argv)
    release_args = ["--release"] if release_mode else []

    try:
        run(
            [
                "uv",
                "run",
                "--project",
                "tools/pytester",
                "ruff",
                "format",
                "--check",
            ]
        )

        run(
            [
                "uv",
                "run",
                "--project",
                "tools/pytester",
                "pytest",
                "tools/pytester",
            ]
        )

        run(["cargo", "fmt", "--check"])
        run(["cargo", "build", *release_args])
        run(["cargo", "test", *release_args])

        formatter_files = gather_pkg_files("std") + gather_pkg_files("boots")
        run_formatter(formatter_files)

        run(["uv", "run", "--script", "tools/run-parse-tests"])

        run(
            [
                "cargo",
                "run",
                "-p",
                "dora",
                *release_args,
                "--",
                "--boots",
                "--report-all-warnings",
                "--emit-compiler",
                "--bootstrap-compiler",
                "tests/boots/hello.dora",
            ]
        )

        pytester_cmd = [
            "uv",
            "run",
            "--project",
            "tools/pytester",
            "pytester",
        ]
        if release_mode:
            pytester_cmd.append("--release")
        pytester_cmd.extend(pytester_args)
        run(pytester_cmd)

        final_cmd = [
            "cargo",
            "run",
            "-p",
            "dora",
            *release_args,
            "--",
            "--boots",
            "--test-boots",
        ]
        if not release_mode:
            final_cmd.append("--gc-verify")
        final_cmd.append("tests/hello-world.dora")
        run(final_cmd)
    except KeyboardInterrupt:
        print("\nAborted by Ctrl-C", file=sys.stderr)
        return 130

    return 0


if __name__ == "__main__":
    sys.exit(main(sys.argv[1:]))
