#!/usr/bin/env -S uv run --script

# /// script
# requires-python = ">=3.12"
# dependencies = []
# ///

import argparse
import shlex
import subprocess
import sys
import tempfile
from pathlib import Path

REPO_ROOT = Path(__file__).resolve().parent.parent
TESTS_DIR = REPO_ROOT / "dora-format" / "tests"


def run_formatter(path: Path) -> str:
    rel_path = str(path.relative_to(REPO_ROOT))
    cmd = ["cargo", "run", "-p", "dora-format", "--", rel_path]
    print("+", " ".join(shlex.quote(part) for part in cmd))
    result = subprocess.run(
        cmd,
        check=True,
        cwd=REPO_ROOT,
        stdout=subprocess.PIPE,
        stderr=subprocess.PIPE,
        text=True,
    )
    return result.stdout


def expected_output_path(input_path: Path) -> Path:
    name = input_path.name
    if name.endswith(".in.dora"):
        expected_name = name.replace(".in.dora", ".out.dora")
        return input_path.with_name(expected_name)
    return input_path.with_suffix(".out.dora")


def parse_args() -> argparse.Namespace:
    parser = argparse.ArgumentParser(description="Run Dora format golden tests.")
    parser.add_argument(
        "--force",
        action="store_true",
        help="Update .out files with current formatter output.",
    )
    parser.add_argument(
        "paths",
        nargs="*",
        type=Path,
        help="Optional .in.dora files to test.",
    )
    return parser.parse_args()


def main() -> int:
    args = parse_args()
    if not TESTS_DIR.is_dir():
        print(f"Missing test directory: {TESTS_DIR}", file=sys.stderr)
        return 1

    if args.paths:
        inputs = []
        for path in args.paths:
            resolved = path if path.is_absolute() else (REPO_ROOT / path)
            inputs.append(resolved)
    else:
        inputs = sorted(TESTS_DIR.rglob("*.in.dora"))
        if not inputs:
            print(f"No .in.dora files found in {TESTS_DIR}.", file=sys.stderr)
            return 1

    mismatches = 0
    for input_path in inputs:
        expected_path = expected_output_path(input_path)
        rel_path = input_path.relative_to(REPO_ROOT)
        print(f"==== {rel_path}")
        if not expected_path.exists() and not args.force:
            print(f"Missing expected output: {expected_path}", file=sys.stderr)
            mismatches += 1
            continue

        actual = run_formatter(input_path)
        if args.force:
            expected_path.write_text(actual)
            continue

        expected = expected_path.read_text()
        if actual != expected:
            with tempfile.NamedTemporaryFile(
                mode="w", suffix=".out.dora", delete=False, encoding="utf-8"
            ) as tmp:
                tmp.write(actual)
                actual_path = Path(tmp.name)

            diff_cmd = ["diff", str(actual_path), str(expected_path)]
            print("+", " ".join(shlex.quote(part) for part in diff_cmd))
            subprocess.run(diff_cmd, cwd=REPO_ROOT)
            print(
                f"vimdiff {shlex.quote(str(actual_path))} {shlex.quote(str(expected_path))}"
            )
            mismatches += 1

    if mismatches:
        print(f"{mismatches} golden file(s) mismatched", file=sys.stderr)
        return 1

    return 0


if __name__ == "__main__":
    sys.exit(main())
